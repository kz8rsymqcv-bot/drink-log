<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>飲料紀錄</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="飲料紀錄" />
  <meta name="theme-color" content="#F2F4EF" />

  <!-- iOS 主畫面 icon（吃你現在的 .PNG） -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.PNG" />
  <!-- 一般瀏覽器 favicon -->
  <link rel="icon" type="image/png" href="./apple-touch-icon.PNG" />

  <style>
    :root{
      --main:#8A9A5B;
      --main-dark:#556B2F;
      --bg:#F2F4EF;
      --weekend:#C08282;

      --good:#8A9A5B;
      --good-bg:#E1EAD1;

      --bad:#CD5C5C;
      --bad-bg:#FEE2E2;

      --card:#ffffffcc;
      --card2:#ffffffee;
      --muted:#94a3b8;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", system-ui, sans-serif;
      background:var(--bg);
      color:var(--main-dark);
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }

    /* 避免 iOS 底部黑邊 */
    body{
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .app{
      max-width: 420px;
      margin: 0 auto;
      padding: 14px 14px 12px;
      min-height: 100svh;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* Header */
    .header{
      display:flex;
      justify-content:center;
      align-items:center;
      padding-top: 2px;
    }
    .titleWrap{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .title{
      font-weight: 900;
      letter-spacing: .18em;
      color: var(--main);
      font-size: 18px;
      text-align:center;
    }
    .editIcon{
      width:16px; height:16px;
      opacity:.55;
    }
    .titleInput{
      width: min(320px, 92vw);
      border:2px solid var(--main);
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 16px;
      font-weight: 800;
      color: var(--main);
      outline:none;
      background:white;
      text-align:center;
    }

    /* Cards */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .stat{
      background: var(--card);
      border:1px solid #fff;
      border-radius: 22px;
      padding: 10px 12px;
      text-align:center;
      box-shadow: 0 4px 14px rgba(0,0,0,.04);
      position:relative;
      overflow:hidden;
    }
    .stat::before{
      content:"";
      position:absolute;
      left:0; top:0; right:0;
      height:4px;
      background: rgba(138,154,91,.18);
    }
    .stat.red::before{ background: rgba(205,92,92,.20); }
    .statLabel{
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.18em;
      margin-bottom:6px;
      color: var(--main);
    }
    .stat.red .statLabel{ color: var(--bad); }
    .statValue{
      font-size: 15px;
      font-weight: 900;
      color:#334155;
    }
    .statValue small{
      font-weight:800;
      font-size: 11px;
      color:#94a3b8;
      margin-left:4px;
    }
    .statMoney{
      margin-left:8px;
      font-weight: 900;
      color: var(--main-dark);
    }
    .stat.red .statMoney{ color: var(--bad); }

    /* Month bar */
    .monthBar{
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .monthPill{
      display:flex;
      align-items:center;
      gap:18px;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(255,255,255,.7);
      border-radius: 999px;
      padding: 8px 14px;
      box-shadow: 0 4px 14px rgba(0,0,0,.04);
    }
    .btnIcon{
      border:none;
      background:transparent;
      cursor:pointer;
      font-size: 18px;
      font-weight: 900;
      color: var(--main);
      transform-origin:center;
    }
    .btnIcon:active{ transform: scale(.88); }
    .monthText{
      min-width: 96px;
      text-align:center;
      font-weight: 900;
      color: var(--main-dark);
      letter-spacing: .04em;
    }
    .todayBtn{
      margin-left:10px;
      border:none;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(255,255,255,.7);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 900;
      color: var(--main-dark);
      cursor:pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,.04);
    }
    .todayBtn:active{ transform: scale(.98); }

    /* Calendar */
    .calCard{
      background: var(--card2);
      border:1px solid #fff;
      border-radius: 28px;
      padding: 14px;
      box-shadow: 0 4px 14px rgba(0,0,0,.05);
    }
    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      text-align:center;
      font-size: 11px;
      font-weight: 900;
      margin-bottom: 10px;
      color: rgba(165,185,151,.95);
    }
    .dow div:first-child,.dow div:last-child{ color: var(--weekend); }

    /* 固定 6 週格：不需要 scroll，也不留巨大空白 */
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
    }
    .cell{
      aspect-ratio: 1/1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.6);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      box-shadow: 0 2px 8px rgba(0,0,0,.04);
      user-select:none;
      cursor:pointer;
      background: rgba(255,255,255,.35);
      position:relative;
      overflow:hidden;
    }
    .cell:active{ transform: scale(.96); }
    .cell.empty{
      background: transparent;
      border: none;
      box-shadow:none;
      cursor:default;
    }
    .dayNum{
      font-size: 12px;
      font-weight: 900;
      color: var(--main-dark);
      line-height: 1;
    }
    .dayNum.weekend{ color: var(--weekend); }
    .daySum{
      margin-top: 4px;
      font-size: 9px;
      font-weight: 900;
      color: rgba(100,116,139,.55);
      line-height: 1;
    }
    .bg1{ background: #E1EAD1; }
    .bg2{ background: #FEF5D4; }
    .bg3{ background: #FEE2E2; }

    /* Bottom */
    .bottom{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .topCard{
      background: rgba(255,255,255,.70);
      border:1px solid rgba(255,255,255,.8);
      border-radius: 22px;
      padding: 12px 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,.04);
      display:flex;
      align-items:center;
      gap:10px;
      overflow:hidden;
    }
    .topBadge{
      width:38px; height:38px;
      border-radius: 999px;
      background: var(--main);
      color: white;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      flex:0 0 auto;
      box-shadow: 0 6px 16px rgba(0,0,0,.08);
    }
    .comboRow{
      display:flex;
      gap:8px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
      flex:1 1 auto;
    }
    .comboRow::-webkit-scrollbar{ display:none; }
    .combo{
      min-width: 92px;
      background:white;
      border:1px solid #E1EAD1;
      border-radius: 14px;
      padding: 7px 10px;
      text-align:center;
      flex:0 0 auto;
    }
    .comboName{
      font-weight:900;
      font-size: 11px;
      max-width: 110px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--main-dark);
    }
    .comboCount{
      margin-top: 2px;
      font-size: 9px;
      font-weight: 900;
      color: rgba(148,163,184,.7);
    }

    /* good/bad buttons like 圖3 */
    .grid2btn{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .pillBtn{
      background: rgba(255,255,255,.70);
      border:1px solid rgba(255,255,255,.8);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,.04);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight: 900;
      font-size: 13px;
      color: var(--main-dark);
      user-select:none;
    }
    .pillBtn:active{ transform: scale(.98); }
    .ico{
      width:18px;height:18px; display:inline-block;
    }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }

    /* Modal overlay */
    .overlay{
      position: fixed;
      inset:0;
      background: rgba(85,107,47,.40);
      backdrop-filter: blur(10px);
      z-index: 999;
      display:flex;
      align-items:flex-end;
    }
    .sheet{
      width:100%;
      background: #FAFBF9;
      border-radius: 34px 34px 0 0;
      box-shadow: 0 -10px 40px rgba(0,0,0,.20);
      max-height: 88svh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .sheetHeader{
      padding: 16px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex:0 0 auto;
    }
    .sheetTitle{
      font-weight: 900;
      font-size: 20px;
      color: var(--main-dark);
    }
    .closeBtn{
      width:34px;height:34px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.8);
      background:white;
      color: rgba(148,163,184,.9);
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,.06);
    }
    .sheetBody{
      padding: 0 16px 12px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }
    .sheetFooter{
      padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(250,251,249,1), rgba(250,251,249,.65));
      flex:0 0 auto;
    }
    .saveBtn{
      width:100%;
      padding: 16px 12px;
      border:none;
      border-radius: 22px;
      background: var(--main-dark);
      color: white;
      font-weight: 900;
      font-size: 18px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(85,107,47,.35);
    }
    .saveBtn:active{ transform: scale(.99); }

    /* Drink card */
    .drinkCard{
      border-radius: 28px;
      padding: 14px;
      margin-bottom: 12px;
      background: white;
      border:1px solid rgba(255,255,255,.9);
      box-shadow: 0 6px 16px rgba(0,0,0,.05);
    }
    .drinkCard.dashed{
      background: #F2F4EF;
      border:2px dashed #DDE4D1;
      box-shadow:none;
    }
    .drinkTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .noBadge{
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--main);
      color: white;
      font-weight: 900;
      font-size: 11px;
      letter-spacing: .12em;
      flex:0 0 auto;
    }
    .miniBtns{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .miniBtn{
      width:34px; height:34px;
      border-radius: 12px;
      border:none;
      background: transparent;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(148,163,184,.6);
    }
    .miniBtn:active{ transform: scale(.95); }

    .miniBtn.goodOn{ background: var(--good-bg); color: var(--good); }
    .miniBtn.badOn{ background: var(--bad-bg); color: var(--bad); }

    .trashBtn{ color: rgba(148,163,184,.45); }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom: 10px;
      max-width: 100%;
    }
    .inp{
      width:100%;
      border:none;
      border-radius: 16px;
      padding: 12px 12px;
      background: #F2F4EF;
      font-size: 16px;
      font-weight: 900;
      outline:none;
      color:#0f172a;
      /* 防止跑版 */
      min-width: 0;
    }
    .inp::placeholder{ color: rgba(148,163,184,.9); font-weight: 900; }
    .inp:focus{ box-shadow: 0 0 0 2px rgba(138,154,91,.35); }

    .sectionLabel{
      font-size: 11px;
      font-weight: 900;
      color: rgba(165,185,151,.95);
      margin: 6px 0 6px 6px;
    }
    .optRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom: 10px;
    }
    .opt{
      border:none;
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      background: #F2F4EF;
      color: rgba(165,185,151,.95);
      user-select:none;
    }
    .opt.on{
      background: var(--main);
      color:white;
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
    }

    .moneyWrap{
      position: relative;
      margin-top: 4px;
    }
    .moneySign{
      position:absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--main);
      font-weight: 900;
    }
    .money{
      padding-left: 30px;
    }

    .addCardBtn{
      width:100%;
      padding: 18px 12px;
      border:none;
      background: transparent;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      color: rgba(165,185,151,.95);
      font-weight: 900;
      font-size: 14px;
      user-select:none;
    }
    .plus{
      width:26px;height:26px;
      border-radius: 999px;
      border:2px solid rgba(165,185,151,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
    }

    /* Detail modal */
    .detailOverlay{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
    }
    .detailBox{
      width: min(420px, 92vw);
      background: white;
      border-radius: 34px;
      padding: 18px 18px 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      max-height: 78svh;
      display:flex;
      flex-direction:column;
    }
    .detailTitle{
      font-weight: 900;
      text-align:center;
      margin-bottom: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .detailList{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 6px 2px;
      flex:1 1 auto;
    }
    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: #F2F4EF;
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 8px;
    }
    .row small{ opacity:.45; font-weight: 900; }
    .close2{
      margin-top: 10px;
      padding: 12px 12px;
      border:none;
      background: var(--main-dark);
      color:white;
      font-weight: 900;
      border-radius: 18px;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <div class="app" id="app"></div>

<script>
  /* ======= Storage Keys ======= */
  const KEY_DATA  = 'fpj_offline_data_v2';
  const KEY_TITLE = 'fpj_app_title';

  /* ======= State ======= */
  const state = {
    currentDate: new Date(2026, 0, 1),
    selectedDate: null,
    records: JSON.parse(localStorage.getItem(KEY_DATA) || '{}'),
    title: localStorage.getItem(KEY_TITLE) || '一隻肥豬嘉的誕生',
    editingTitle: false,
    detailView: null, // 'good' | 'bad'
    modalOpen: false
  };

  const iceOptions   = ["正常","少冰","微冰","去冰","常溫","溫","熱","固定"];
  const sugarOptions = ["全糖","少糖","半糖","微糖","一分","0.5分","無糖","固定"];

  function save(){
    localStorage.setItem(KEY_DATA, JSON.stringify(state.records));
  }
  function saveTitle(t){
    state.title = t;
    localStorage.setItem(KEY_TITLE, t);
  }

  function pad2(n){ return String(n).padStart(2,'0'); }
  function dateKey(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  function today(){
    const t = new Date();
    state.currentDate = new Date(t.getFullYear(), t.getMonth(), 1);
    render();
  }

  function calcStats(){
    let mTotal=0,mCount=0,yTotal=0,yCount=0;
    const comboFreq = {};
    const goodList = [];
    const badList  = [];

    const cy = state.currentDate.getFullYear();
    const cm = state.currentDate.getMonth();

    for(const k of Object.keys(state.records)){
      const d = new Date(k);
      const isYear  = d.getFullYear() === cy;
      const isMonth = isYear && d.getMonth() === cm;

      const arr = state.records[k] || [];
      for(const drink of arr){
        const p = Number(drink.price || 0);
        const name = `${drink.shop||''}-${drink.item||''}`.trim();

        if(isYear){ yTotal += p; yCount++; }
        if(isMonth){ mTotal += p; mCount++; }

        if(drink.shop && drink.item){
          comboFreq[name] = (comboFreq[name]||0) + 1;
        }
        if(drink.rating === 'good') goodList.push({name, date:k});
        if(drink.rating === 'bad')  badList.push({name, date:k});
      }
    }

    const topCombos = Object.entries(comboFreq).sort((a,b)=>b[1]-a[1]).slice(0,3);
    return {mTotal,mCount,yTotal,yCount,topCombos,goodList,badList};
  }

  /* ======= Render Main ======= */
  function render(){
    const app = document.getElementById('app');
    const stats = calcStats();

    app.innerHTML = `
      <div class="header">
        ${state.editingTitle
          ? `<input class="titleInput" id="titleInput" value="${escapeHtml(state.title)}" />`
          : `<div class="titleWrap" id="titleWrap" role="button">
               <div class="title">${escapeHtml(state.title)}</div>
               <svg class="editIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--main)">
                 <path d="M12 20h9"></path>
                 <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
               </svg>
             </div>`
        }
      </div>

      <div class="grid2">
        <div class="stat red">
          <div class="statLabel">年度累計</div>
          <div class="statValue">${stats.yCount}<small>杯</small><span class="statMoney">$${Number(stats.yTotal).toLocaleString()}</span></div>
        </div>
        <div class="stat">
          <div class="statLabel">本月統計</div>
          <div class="statValue">${stats.mCount}<small>杯</small><span class="statMoney">$${Number(stats.mTotal).toLocaleString()}</span></div>
        </div>
      </div>

      <div class="monthBar">
        <div class="monthPill">
          <button class="btnIcon" id="prevMonth" aria-label="prev">〈</button>
          <div class="monthText">${state.currentDate.getFullYear()}.${pad2(state.currentDate.getMonth()+1)}</div>
          <button class="btnIcon" id="nextMonth" aria-label="next">〉</button>
        </div>
        <button class="todayBtn" id="goToday">今天</button>
      </div>

      <div class="calCard">
        <div class="dow">
          <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
        </div>
        <div class="calGrid">
          ${renderCalendarCells()}
        </div>
      </div>

      <div class="bottom">
        <div class="topCard">
          <div class="topBadge" title="TOP">TOP</div>
          <div class="comboRow">
            ${
              stats.topCombos.length
              ? stats.topCombos.map(([combo,count])=>`
                  <div class="combo">
                    <div class="comboName" title="${escapeHtml(combo)}">${escapeHtml(combo)}</div>
                    <div class="comboCount">${count} 次</div>
                  </div>
                `).join('')
              : `<div style="font-weight:900;color:rgba(148,163,184,.8);font-size:12px;padding-left:6px;">尚未產生排名...</div>`
            }
          </div>
        </div>

        <div class="grid2btn">
          <button class="pillBtn" id="openGood">
            ${thumbUpSvg('good')}
            <span class="good">讚讚</span> (${stats.goodList.length})
          </button>
          <button class="pillBtn" id="openBad">
            ${thumbDownSvg('bad')}
            <span class="bad">踩雷</span> (${stats.badList.length})
          </button>
        </div>
      </div>
    `;

    // Bind main events
    if(state.editingTitle){
      const inp = document.getElementById('titleInput');
      inp.focus();
      inp.addEventListener('blur', ()=>{
        const v = inp.value.trim() || '一隻肥豬嘉的誕生';
        saveTitle(v);
        state.editingTitle = false;
        render();
      });
      inp.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') inp.blur();
      });
    }else{
      document.getElementById('titleWrap').addEventListener('click', ()=>{
        state.editingTitle = true;
        render();
      });
    }

    document.getElementById('prevMonth').addEventListener('click', ()=>{
      state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth()-1, 1);
      render();
    });
    document.getElementById('nextMonth').addEventListener('click', ()=>{
      state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth()+1, 1);
      render();
    });
    document.getElementById('goToday').addEventListener('click', today);

    document.getElementById('openGood').addEventListener('click', ()=> openDetail('good'));
    document.getElementById('openBad').addEventListener('click', ()=> openDetail('bad'));
  }

  function renderCalendarCells(){
    const y = state.currentDate.getFullYear();
    const m = state.currentDate.getMonth();
    const firstDay = new Date(y,m,1).getDay();
    const daysInMonth = new Date(y,m+1,0).getDate();

    // 固定 42 格（6週），不做 scroll，不留大空白
    let html = '';
    for(let i=0;i<42;i++){
      const day = i - firstDay + 1;
      if(day<=0 || day>daysInMonth){
        html += `<div class="cell empty"></div>`;
        continue;
      }
      const dObj = new Date(y,m,day);
      const key = dateKey(dObj);
      const list = state.records[key] || [];
      const count = list.length;
      const isWeekend = (i%7===0) || (i%7===6);

      let bg = '';
      if(count===1) bg='bg1';
      else if(count===2) bg='bg2';
      else if(count>=3) bg='bg3';

      const sum = list.reduce((s,x)=> s + Number(x.price||0), 0);

      html += `
        <div class="cell ${bg}" data-day="${day}">
          <div class="dayNum ${isWeekend?'weekend':''}">${day}</div>
          ${count>0 ? `<div class="daySum">$${sum}</div>` : ``}
        </div>
      `;
    }

    // after render bind click by delegation in render()
    // but here we return html only; binding happens below:
    setTimeout(bindCalendarClicks, 0);
    return html;
  }

  function bindCalendarClicks(){
    document.querySelectorAll('.cell[data-day]').forEach(el=>{
      el.onclick = ()=>{
        const day = Number(el.dataset.day);
        openEditModal(day);
      };
    });
  }

  /* ======= Modal: Edit Drinks (fix focus+scroll jump) ======= */
  function openEditModal(day){
    const y = state.currentDate.getFullYear();
    const m = state.currentDate.getMonth();
    state.selectedDate = new Date(y,m,day);
    state.modalOpen = true;

    const key = dateKey(state.selectedDate);
    if(!state.records[key]) state.records[key] = [];

    // lock body scroll
    document.body.style.overflow = 'hidden';

    renderEditModal({ preserve: false });
  }

  function closeEditModal(){
    const old = document.getElementById('editOverlay');
    if(old) old.remove();
    state.modalOpen = false;
    state.selectedDate = null;

    // unlock body scroll
    document.body.style.overflow = '';

    render(); // refresh main
  }

  // preserve keeps current scrollTop + focused input location
  function renderEditModal({ preserve }){
    const key = dateKey(state.selectedDate);
    const list = state.records[key] || [];

    const prevOverlay = document.getElementById('editOverlay');
    let prevScroll = 0;
    let focusInfo = null;

    if(preserve && prevOverlay){
      const body = prevOverlay.querySelector('.sheetBody');
      prevScroll = body ? body.scrollTop : 0;

      const ae = document.activeElement;
      if(ae && ae.dataset && ae.dataset.idx && ae.dataset.field){
        focusInfo = { idx: ae.dataset.idx, field: ae.dataset.field };
      }
    }

    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    overlay.id = 'editOverlay';
    overlay.innerHTML = `
      <div class="sheet" role="dialog" aria-modal="true">
        <div class="sheetHeader">
          <div class="sheetTitle">${state.selectedDate.getMonth()+1}月${state.selectedDate.getDate()}日</div>
          <button class="closeBtn" id="closeEdit" aria-label="close">✕</button>
        </div>

        <div class="sheetBody" id="sheetBody">
          ${renderDrinkCards(list)}
        </div>

        <div class="sheetFooter">
          <button class="saveBtn" id="saveEdit">儲存紀錄</button>
        </div>
      </div>
    `;

    // remove old & append new
    if(prevOverlay) prevOverlay.remove();
    document.body.appendChild(overlay);

    // bind close / save
    document.getElementById('closeEdit').onclick = closeEditModal;
    document.getElementById('saveEdit').onclick  = closeEditModal;

    // restore scroll & focus
    const body = document.getElementById('sheetBody');
    if(preserve && body){
      body.scrollTop = prevScroll;
      if(focusInfo){
        const sel = `[data-idx="${focusInfo.idx}"][data-field="${focusInfo.field}"]`;
        const target = document.querySelector(sel);
        if(target){
          target.focus({ preventScroll: true });
          // keep cursor at end
          try{
            const v = target.value;
            target.setSelectionRange(v.length, v.length);
          }catch(e){}
        }
      }
    }
  }

  function renderDrinkCards(list){
    // 顯示邏輯：第1杯恆顯示，後面要上一杯有 item 才顯示；最多 3 杯
    let html = '';

    for(let i=0;i<3;i++){
      const drink = list[i];
      const exists = !!drink;

      const canShow = i===0 || (list[i-1] && (list[i-1].item||'').trim().length>0);
      if(!canShow) continue;

      if(!exists){
        html += `
          <div class="drinkCard dashed">
            <button class="addCardBtn" data-add="${i}">
              <span class="plus">+</span>
              新增第 ${i+1} 杯
            </button>
          </div>
        `;
      }else{
        html += `
          <div class="drinkCard">
            <div class="drinkTop">
              <div class="noBadge">NO.${i+1}</div>
              <div class="miniBtns">
                <button class="miniBtn ${drink.rating==='good'?'goodOn':''}" data-rate="${i}" data-val="good" aria-label="good">
                  ${thumbUpSvg('good')}
                </button>
                <button class="miniBtn ${drink.rating==='bad'?'badOn':''}" data-rate="${i}" data-val="bad" aria-label="bad">
                  ${thumbDownSvg('bad')}
                </button>
                <button class="miniBtn trashBtn" data-del="${i}" aria-label="delete">
                  ${trashSvg()}
                </button>
              </div>
            </div>

            <div class="twoCol">
              <input class="inp" type="text" placeholder="店家"
                     value="${escapeAttr(drink.shop||'')}"
                     data-idx="${i}" data-field="shop" />
              <input class="inp" type="text" placeholder="品項"
                     value="${escapeAttr(drink.item||'')}"
                     data-idx="${i}" data-field="item" />
            </div>

            <div class="sectionLabel">甜度</div>
            <div class="optRow">
              ${sugarOptions.map(opt => `
                <button class="opt ${drink.sugar===opt?'on':''}" data-opt="${i}" data-field="sugar" data-val="${escapeAttr(opt)}">${opt}</button>
              `).join('')}
            </div>

            <div class="sectionLabel">冰量</div>
            <div class="optRow">
              ${iceOptions.map(opt => `
                <button class="opt ${drink.ice===opt?'on':''}" data-opt="${i}" data-field="ice" data-val="${escapeAttr(opt)}">${opt}</button>
              `).join('')}
            </div>

            <div class="moneyWrap">
              <span class="moneySign">$</span>
              <input class="inp money" type="number" inputmode="decimal" placeholder="金額"
                     value="${drink.price ? escapeAttr(String(drink.price)) : ''}"
                     data-idx="${i}" data-field="price" />
            </div>
          </div>
        `;
      }
    }

    // Bind after DOM insert
    setTimeout(bindModalEvents, 0);
    return html;
  }

  function ensureDrink(key, idx){
    while((state.records[key]||[]).length <= idx){
      state.records[key].push({ shop:'', item:'', ice:'去冰', sugar:'無糖', price:0, rating:null });
    }
  }

  function bindModalEvents(){
    const key = dateKey(state.selectedDate);

    // Add buttons
    document.querySelectorAll('[data-add]').forEach(btn=>{
      btn.onclick = ()=>{
        const idx = Number(btn.dataset.add);
        ensureDrink(key, idx);
        save();
        renderEditModal({ preserve:true });
      };
    });

    // Delete buttons
    document.querySelectorAll('[data-del]').forEach(btn=>{
      btn.onclick = ()=>{
        const idx = Number(btn.dataset.del);
        (state.records[key]||[]).splice(idx,1);
        if((state.records[key]||[]).length===0) delete state.records[key];
        save();
        // if day cleared, close modal gracefully
        if(!state.records[key]){
          closeEditModal();
          return;
        }
        renderEditModal({ preserve:true });
      };
    });

    // Rating buttons
    document.querySelectorAll('[data-rate]').forEach(btn=>{
      btn.onclick = ()=>{
        const idx = Number(btn.dataset.rate);
        ensureDrink(key, idx);
        const val = btn.dataset.val; // good | bad
        const cur = state.records[key][idx].rating;
        state.records[key][idx].rating = (cur===val) ? null : val;
        save();
        renderEditModal({ preserve:true });
      };
    });

    // Option buttons
    document.querySelectorAll('[data-opt]').forEach(btn=>{
      btn.onclick = ()=>{
        const idx = Number(btn.dataset.opt);
        const field = btn.dataset.field;
        const val = btn.dataset.val;
        ensureDrink(key, idx);
        state.records[key][idx][field] = val;
        save();
        renderEditModal({ preserve:true });
      };
    });

    // Inputs: use input event to keep cursor & not jump to top
    document.querySelectorAll('input[data-idx][data-field]').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const idx = Number(inp.dataset.idx);
        const field = inp.dataset.field;
        ensureDrink(key, idx);
        let v = inp.value;

        if(field === 'price'){
          state.records[key][idx][field] = v==='' ? 0 : Number(v);
        }else{
          state.records[key][idx][field] = v;
        }
        save();

        // 這裡不立刻重畫整個 modal（避免跳動）
        // 但為了讓「下一杯可顯示」與「日曆顏色」更新，我們做一個輕量重畫：保留 scroll+focus
        renderEditModal({ preserve:true });
      }, { passive:true });
    });
  }

  /* ======= Detail Modal ======= */
  function openDetail(type){
    state.detailView = type;
    const stats = calcStats();
    const list = type==='good' ? stats.goodList : stats.badList;

    // lock body scroll
    document.body.style.overflow = 'hidden';

    const overlay = document.createElement('div');
    overlay.className = 'detailOverlay';
    overlay.id = 'detailOverlay';
    overlay.addEventListener('click', closeDetail);

    const titleColor = type==='good' ? 'var(--good)' : 'var(--bad)';
    const titleText  = type==='good' ? '讚讚清單' : '踩雷紀錄';
    const iconSvg    = type==='good' ? thumbUpSvg('good') : thumbDownSvg('bad');

    overlay.innerHTML = `
      <div class="detailBox" onclick="event.stopPropagation()">
        <div class="detailTitle" style="color:${titleColor}">
          ${iconSvg} <span style="font-weight:900">${titleText}</span>
        </div>
        <div class="detailList">
          ${
            list.length
            ? list.map(d=>`
                <div class="row">
                  <div style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(d.name)}</div>
                  <small>${escapeHtml(d.date.slice(5))}</small>
                </div>
              `).join('')
            : `<div style="text-align:center;color:rgba(148,163,184,.7);font-weight:900;padding:18px 0;">尚無資料</div>`
          }
        </div>
        <button class="close2" id="closeDetailBtn">關閉</button>
      </div>
    `;

    document.body.appendChild(overlay);
    document.getElementById('closeDetailBtn').onclick = closeDetail;
  }

  function closeDetail(){
    const d = document.getElementById('detailOverlay');
    if(d) d.remove();
    state.detailView = null;
    document.body.style.overflow = '';
  }

  /* ======= SVG icons (outline, no emoji) ======= */
  function thumbUpSvg(kind){
    const color = (kind==='good') ? 'currentColor' : 'currentColor';
    return `
      <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9A2 2 0 0 0 19.7 9H14z"></path>
        <path d="M7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
      </svg>
    `;
  }
  function thumbDownSvg(kind){
    const color = (kind==='bad') ? 'currentColor' : 'currentColor';
    return `
      <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
        <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9A2 2 0 0 0 4.3 15H10z"></path>
        <path d="M17 2h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"></path>
      </svg>
    `;
  }
  function trashSvg(){
    return `
      <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 6h18"></path>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
        <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    `;
  }

  /* ======= Helpers ======= */
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function escapeAttr(s){
    return escapeHtml(s).replace(/"/g,'&quot;');
  }

  /* ======= Init ======= */
  render();
</script>
</body>
</html>