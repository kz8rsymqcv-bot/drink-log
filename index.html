<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>飲料紀錄</title>

  <!-- iOS PWA 基本設定 -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="飲料紀錄" />

  <!-- iOS 主畫面 icon（同時支援 .PNG 與 .png，避免你手機上傳變大寫副檔名） -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.PNG">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">

  <!-- 一般瀏覽器 favicon（可有可無） -->
  <link rel="icon" type="image/png" href="./apple-touch-icon.PNG">
  <link rel="icon" type="image/png" href="./apple-touch-icon.png">

  <style>
    :root{
      --main:#8A9A5B;
      --deep:#556B2F;
      --bg:#F2F4EF;
      --weekend:#C08282;
      --danger:#CD5C5C;
      --soft:#FAFBF9;
      --card:#FFFFFF;
      --muted:#A5B997;
      --shadow: 0 10px 30px rgba(85,107,47,.12);
      --radius-xl: 2rem;
      --radius-lg: 1.5rem;
      --radius-md: 1.1rem;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; background:var(--bg); }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      color: var(--deep);
    }

    /* 讓輸入法正常，不要全站 user-select none（會害中文輸入各種怪） */
    .no-select{ user-select:none; }

    .app{
      max-width: 420px;
      margin: 0 auto;
      padding: 14px 14px 10px;
      height: 100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .row{ display:flex; align-items:center; justify-content:center; }
    .header{
      padding: 10px 0 12px;
      flex: 0 0 auto;
    }

    .titleWrap{
      display:flex; gap:8px; align-items:center; justify-content:center;
      cursor:pointer;
    }
    .title{
      font-weight: 900;
      letter-spacing: .18em;
      color: var(--main);
      font-size: 18px;
      text-align:center;
      max-width: 320px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .editIcon{
      width:14px; height:14px; opacity:.55;
    }
    .titleInput{
      width: 100%;
      max-width: 280px;
      font-size: 18px;
      font-weight: 900;
      border-radius: 999px;
      border: 2px solid var(--main);
      padding: 6px 14px;
      outline:none;
      background: white;
      color: var(--main);
      text-align:center;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      flex: 0 0 auto;
      margin-bottom: 10px;
    }
    .statCard{
      background: rgba(255,255,255,.82);
      border: 1px solid rgba(255,255,255,.9);
      border-radius: var(--radius-lg);
      padding: 12px 12px 10px;
      position:relative;
      box-shadow: 0 4px 14px rgba(85,107,47,.08);
      text-align:center;
      overflow:hidden;
    }
    .statBar{
      position:absolute; left:0; top:0; height:4px; width:100%;
      background: rgba(205,92,92,.18);
    }
    .statBar.green{ background: rgba(138,154,91,.18); }
    .statLabel{
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .18em;
      margin-bottom: 6px;
      color: var(--danger);
    }
    .statLabel.green{ color: var(--main); }
    .statValue{
      font-size: 14px;
      font-weight: 900;
      color: #334155;
    }
    .statValue small{ font-size: 10px; color:#94a3b8; font-weight:800; }
    .statValue .money.red{ color: var(--danger); margin-left: 6px; }
    .statValue .money.green{ color: var(--deep); margin-left: 6px; }

    .monthBar{
      flex: 0 0 auto;
      display:flex;
      justify-content:center;
      margin-bottom: 10px;
    }
    .monthPill{
      display:flex; align-items:center; gap: 16px;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(255,255,255,.8);
      border-radius: 999px;
      padding: 6px 14px;
      box-shadow: 0 4px 14px rgba(85,107,47,.08);
    }
    .navBtn{
      border:0; background:transparent;
      font-size: 18px;
      font-weight: 900;
      color: var(--main);
      cursor:pointer;
      padding: 2px 8px;
      transform: translateY(-1px);
    }
    .navBtn:active{ transform: translateY(-1px) scale(.9); }
    .monthText{
      min-width: 86px;
      text-align:center;
      font-weight: 900;
      color: var(--deep);
      letter-spacing: .04em;
    }
    .todayBtn{
      border: 1px solid rgba(138,154,91,.25);
      background: rgba(138,154,91,.12);
      color: var(--deep);
      font-weight: 900;
      border-radius: 999px;
      padding: 6px 10px;
      cursor:pointer;
    }
    .todayBtn:active{ transform: scale(.96); }

    .calendarCard{
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(255,255,255,.9);
      border-radius: var(--radius-xl);
      padding: 14px;
      box-shadow: 0 6px 18px rgba(85,107,47,.08);
      flex: 1 1 auto;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      min-height: 0;
    }
    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 10px;
      flex: 0 0 auto;
    }
    .dow div{
      text-align:center;
      font-size: 10px;
      font-weight: 900;
      color: var(--muted);
    }
    .dow div.weekend{ color: var(--weekend); }

    /* ⭐ 這裡修掉你說的「日曆下面空白太大」：不要固定 42 格，改成「剛好需要幾格」 */
    .grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      overflow:auto;
      padding-bottom: 6px;
      -webkit-overflow-scrolling: touch;
    }
    .grid::-webkit-scrollbar{ display:none; }

    .day{
      aspect-ratio: 1 / 1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.7);
      background: rgba(255,255,255,.4);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      position:relative;
      box-shadow: 0 2px 10px rgba(85,107,47,.06);
    }
    .day:active{ transform: scale(.96); }
    .day .num{
      font-size: 11px;
      font-weight: 900;
      color: var(--deep);
      line-height: 1;
    }
    .day.weekend .num{ color: var(--weekend); }
    .day .sum{
      margin-top: 4px;
      font-size: 8px;
      font-weight: 900;
      color: #94a3b8;
      line-height: 1;
    }
    .bg1{ background: #E1EAD1; }
    .bg2{ background: #FEF5D4; }
    .bg3{ background: #FEE2E2; }

    .bottom{
      flex: 0 0 auto;
      padding-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .topCard{
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(255,255,255,.85);
      border-radius: var(--radius-lg);
      padding: 12px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
      box-shadow: 0 4px 14px rgba(85,107,47,.08);
      overflow:hidden;
    }
    .topBadge{
      width: 38px; height: 38px;
      border-radius: 999px;
      background: var(--main);
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight: 900;
      font-size: 12px;
      flex: 0 0 auto;
    }
    .topList{
      display:flex;
      gap: 8px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }
    .topList::-webkit-scrollbar{ display:none; }
    .combo{
      min-width: 86px;
      background:white;
      border: 1px solid #E1EAD1;
      border-radius: 14px;
      padding: 8px 10px;
      text-align:center;
      flex: 0 0 auto;
    }
    .combo .name{
      font-size: 10px;
      font-weight: 900;
      color: var(--deep);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .combo .cnt{
      margin-top: 2px;
      font-size: 8px;
      font-weight: 900;
      color: #cbd5e1;
    }

    .twoBtn{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .btnCard{
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(255,255,255,.85);
      border-radius: var(--radius-md);
      padding: 12px 10px;
      box-shadow: 0 4px 14px rgba(85,107,47,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .btnCard:active{ transform: scale(.97); }

    .icon{
      width: 18px; height: 18px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .goodColor{ color: var(--deep); }
    .badColor{ color: var(--danger); }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(85,107,47,.40);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display:flex;
      align-items:flex-end;
    }
    .sheet{
      width:100%;
      background: var(--soft);
      border-radius: 2.5rem 2.5rem 0 0;
      max-height: 85vh;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 18px 16px 22px;
      box-shadow: var(--shadow);
    }
    .sheet::-webkit-scrollbar{ display:none; }

    .sheetHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 14px;
    }
    .sheetHead h3{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      color: var(--deep);
    }
    .closeBtn{
      width: 36px; height: 36px;
      border-radius: 999px;
      border:0;
      background: white;
      box-shadow: 0 4px 14px rgba(85,107,47,.08);
      color: #cbd5e1;
      font-weight: 900;
      cursor:pointer;
    }
    .closeBtn:active{ transform: scale(.96); }

    .drinkCard{
      background: white;
      border: 1px solid rgba(255,255,255,.9);
      border-radius: var(--radius-xl);
      padding: 14px;
      box-shadow: 0 4px 14px rgba(85,107,47,.08);
      margin-bottom: 12px;
    }
    .drinkCard.add{
      background: #F2F4EF;
      border: 2px dashed #DDE4D1;
      box-shadow: none;
    }
    .drinkTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 10px;
    }
    .noPill{
      display:inline-flex;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--main);
      color:white;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .18em;
    }
    .tools{
      display:flex; gap: 8px; align-items:center;
    }
    .toolBtn{
      width: 34px; height: 34px;
      border-radius: 12px;
      border:0;
      background: transparent;
      cursor:pointer;
      color: #cbd5e1;
    }
    .toolBtn.on.good{ background: #E1EAD1; color: var(--main); }
    .toolBtn.on.bad{ background: #FEE2E2; color: var(--danger); }
    .trash{ color: #e2e8f0; }

    .field2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    input[type="text"], input[type="number"]{
      width:100%;
      border:0;
      outline:none;
      background: #F2F4EF;
      border-radius: 14px;
      padding: 14px 12px;
      font-size: 16px; /* iOS 不縮放 + 也較正常觸發中文輸入 */
      font-weight: 900;
      color: #0f172a;
    }
    input::placeholder{ color:#94a3b8; font-weight: 900; }
    .label{
      margin: 8px 0 6px 2px;
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
    }
    .optRow{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    .opt{
      border:0;
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 12px;
      background: #F2F4EF;
      color: var(--muted);
      font-weight: 900;
      font-size: 11px;
    }
    .opt.on{
      background: var(--main);
      color: white;
      box-shadow: 0 6px 16px rgba(138,154,91,.25);
    }

    .priceWrap{ position:relative; margin-top: 10px; }
    .dollar{
      position:absolute;
      left: 12px;
      top: 14px;
      font-weight: 900;
      color: var(--main);
    }
    .priceInput{ padding-left: 32px !important; }

    .addBtn{
      width:100%;
      border:0;
      background: transparent;
      padding: 18px 10px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 6px;
      color: var(--muted);
      font-weight: 900;
    }
    .addBtn:active{ opacity:.6; }

    .saveBig{
      width:100%;
      border:0;
      border-radius: var(--radius-lg);
      background: var(--deep);
      color:white;
      font-weight: 900;
      font-size: 18px;
      padding: 18px 12px;
      box-shadow: 0 14px 28px rgba(85,107,47,.22);
      cursor:pointer;
      margin-top: 10px;
    }
    .saveBig:active{ transform: scale(.98); }

    /* list modal */
    .centerOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      z-index: 1200;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .centerCard{
      width:100%;
      max-width: 420px;
      background:white;
      border-radius: 2.5rem;
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .centerTitle{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      font-weight: 900;
      margin: 6px 0 12px;
    }
    .list{
      max-height: 260px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 4px;
    }
    .list::-webkit-scrollbar{ display:none; }
    .listItem{
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: #F2F4EF;
      border-radius: 14px;
      padding: 12px 12px;
      margin-bottom: 10px;
      font-weight: 900;
      font-size: 12px;
      color: #0f172a;
    }
    .listItem .date{ opacity:.4; font-size: 12px; color:#334155; }
    .empty{
      text-align:center;
      color:#cbd5e1;
      font-weight: 900;
      padding: 26px 0;
      font-size: 12px;
    }
    .closeCenter{
      width:100%;
      border:0;
      border-radius: 14px;
      background: var(--deep);
      color:white;
      font-weight: 900;
      font-size: 14px;
      padding: 14px 12px;
      cursor:pointer;
    }
    .closeCenter:active{ transform: scale(.98); }
  </style>
</head>

<body>
  <div id="app" class="app"></div>

  <script>
    // ---------- Storage Keys ----------
    const KEY_DATA  = "drinklog_offline_v2";
    const KEY_TITLE = "drinklog_title_v2";

    // ---------- Options ----------
    const iceOptions = ["正常","少冰","微冰","去冰","常溫","溫","熱","固定"];
    const sugarOptions = ["全糖","少糖","半糖","微糖","一分","0.5分","無糖","固定"];

    // ---------- State ----------
    const today = new Date();
    let state = {
      currentDate: new Date(2026, 0, 1),
      selectedDate: null,
      appTitle: localStorage.getItem(KEY_TITLE) || "一隻肥豬嘉的誕生",
      isEditingTitle: false,
      records: safeParse(localStorage.getItem(KEY_DATA)) || {}
    };

    // iOS 中文輸入：組字期間不要亂動 DOM
    let isComposing = false;

    // 記住 modal scroll，避免你說的「新增第二杯跳回第一杯」
    let modalScrollTop = 0;
    let lastActiveIdx = 0;

    function safeParse(s){
      try { return JSON.parse(s); } catch(e){ return null; }
    }
    function saveData(){
      localStorage.setItem(KEY_DATA, JSON.stringify(state.records));
    }
    function saveTitle(t){
      state.appTitle = t;
      localStorage.setItem(KEY_TITLE, t);
    }
    function formatDateKey(date){
      return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`;
    }
    function isSameMonth(d1, d2){
      return d1.getFullYear()===d2.getFullYear() && d1.getMonth()===d2.getMonth();
    }

    function calcStats(){
      let mTotal=0,mCount=0,yTotal=0,yCount=0;
      const comboFreq = {};
      const goodList = [];
      const badList = [];

      Object.keys(state.records).forEach(key=>{
        const date = new Date(key);
        const inYear = date.getFullYear()===state.currentDate.getFullYear();
        const inMonth = inYear && date.getMonth()===state.currentDate.getMonth();
        (state.records[key]||[]).forEach(d=>{
          const p = Number(d.price||0);
          if(inYear){ yTotal+=p; yCount++; }
          if(inMonth){ mTotal+=p; mCount++; }

          if(d.shop && d.item){
            const name = `${d.shop}-${d.item}`;
            comboFreq[name] = (comboFreq[name]||0)+1;
          }
          const name2 = `${d.shop||""}-${d.item||""}`.replace(/^-|-$/g,"");
          if(d.rating==="good") goodList.push({name:name2||"(未命名)", date:key});
          if(d.rating==="bad")  badList.push({name:name2||"(未命名)", date:key});
        });
      });

      const topCombos = Object.entries(comboFreq).sort((a,b)=>b[1]-a[1]).slice(0,3);
      return {mTotal,mCount,yTotal,yCount,topCombos,goodList,badList};
    }

    // ---------- Icons (outline) ----------
    function iconPencil(){
      return `
        <svg class="editIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 20h9"/>
          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
        </svg>`;
    }
    function iconThumbUp(){
      return `
        <svg class="icon" viewBox="0 0 24 24">
          <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9A2 2 0 0 0 20.68 9H14z"/>
          <path d="M7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
        </svg>`;
    }
    function iconThumbDown(){
      return `
        <svg class="icon" viewBox="0 0 24 24">
          <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9A2 2 0 0 0 4.34 15H10z"/>
          <path d="M17 2h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"/>
        </svg>`;
    }
    function iconTrash(){
      return `
        <svg class="icon" viewBox="0 0 24 24">
          <path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
          <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>`;
    }
    function iconPlus(){
      return `
        <svg class="icon" viewBox="0 0 24 24">
          <path d="M12 5v14"/><path d="M5 12h14"/>
        </svg>`;
    }

    // ---------- Render Main ----------
    function render(){
      const app = document.getElementById("app");
      const stats = calcStats();

      // month info
      const y = state.currentDate.getFullYear();
      const m = state.currentDate.getMonth();
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const firstDay = new Date(y, m, 1).getDay();

      // ⭐ 動態格數：只渲染到「最後一天所在那一格」
      const totalCells = firstDay + daysInMonth;

      // title
      let titleHTML = "";
      if(state.isEditingTitle){
        titleHTML = `<input id="titleInput" class="titleInput" value="${escapeHtml(state.appTitle)}" />`;
      }else{
        titleHTML = `
          <div class="titleWrap" id="titleWrap">
            <div class="title">${escapeHtml(state.appTitle)}</div>
            <div style="color:var(--main)">${iconPencil()}</div>
          </div>`;
      }

      // calendar cells
      let cells = "";
      for(let i=0;i<totalCells;i++){
        const day = i - firstDay + 1;
        if(day <= 0){
          cells += `<div></div>`;
          continue;
        }
        const key = formatDateKey(new Date(y,m,day));
        const list = state.records[key] || [];
        const count = list.length;
        const sum = count ? list.reduce((s,d)=>s+Number(d.price||0),0) : 0;
        const isWeekend = (i % 7 === 0) || (i % 7 === 6);

        let bg = "";
        if(count===1) bg="bg1";
        if(count===2) bg="bg2";
        if(count>=3) bg="bg3";

        cells += `
          <div class="day ${bg} ${isWeekend?'weekend':''}" data-day="${day}">
            <div class="num">${day}</div>
            ${count>0 ? `<div class="sum">$${sum}</div>` : ``}
          </div>
        `;
      }

      app.innerHTML = `
        <div class="header row">
          ${titleHTML}
        </div>

        <div class="stats no-select">
          <div class="statCard">
            <div class="statBar"></div>
            <div class="statLabel">年度累計</div>
            <div class="statValue">${stats.yCount} <small>杯</small> <span class="money red">$${Number(stats.yTotal).toLocaleString()}</span></div>
          </div>
          <div class="statCard">
            <div class="statBar green"></div>
            <div class="statLabel green">本月統計</div>
            <div class="statValue">${stats.mCount} <small>杯</small> <span class="money green">$${Number(stats.mTotal).toLocaleString()}</span></div>
          </div>
        </div>

        <div class="monthBar no-select">
          <div class="monthPill">
            <button class="navBtn" id="prevMonth">〈</button>
            <div class="monthText">${y}.${String(m+1).padStart(2,"0")}</div>
            <button class="navBtn" id="nextMonth">〉</button>
            <button class="todayBtn" id="goToday">今天</button>
          </div>
        </div>

        <div class="calendarCard no-select">
          <div class="dow">
            <div class="weekend">日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div class="weekend">六</div>
          </div>
          <div class="grid" id="grid">
            ${cells}
          </div>
        </div>

        <div class="bottom no-select">
          <div class="topCard">
            <div class="topBadge">TOP</div>
            <div class="topList">
              ${
                stats.topCombos.length
                ? stats.topCombos.map(([combo,c])=>`
                    <div class="combo">
                      <div class="name" title="${escapeHtml(combo)}">${escapeHtml(combo)}</div>
                      <div class="cnt">${c} 次</div>
                    </div>
                  `).join("")
                : `<div style="color:#94a3b8; font-weight:900; font-size:12px; padding-left:6px;">尚未產生排名...</div>`
              }
            </div>
          </div>

          <div class="twoBtn">
            <div class="btnCard goodColor" id="openGood">
              ${iconThumbUp()}
              <div>讚讚 (${stats.goodList.length})</div>
            </div>
            <div class="btnCard badColor" id="openBad">
              ${iconThumbDown()}
              <div>踩雷 (${stats.badList.length})</div>
            </div>
          </div>
        </div>
      `;

      // title edit bind
      if(state.isEditingTitle){
        const input = document.getElementById("titleInput");
        setTimeout(()=>input.focus(), 0);
        input.addEventListener("blur", ()=>{
          const v = (input.value||"").trim();
          if(v) saveTitle(v);
          state.isEditingTitle=false;
          render();
        });
        input.addEventListener("keydown",(e)=>{
          if(e.key==="Enter"){
            input.blur();
          }
        });
      }else{
        document.getElementById("titleWrap").addEventListener("click", ()=>{
          state.isEditingTitle=true;
          render();
        });
      }

      // month nav
      document.getElementById("prevMonth").onclick = ()=>{ state.currentDate = new Date(y, m-1, 1); render(); };
      document.getElementById("nextMonth").onclick = ()=>{ state.currentDate = new Date(y, m+1, 1); render(); };
      document.getElementById("goToday").onclick = ()=>{
        state.currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
        render();
      };

      // calendar click
      document.getElementById("grid").addEventListener("click",(e)=>{
        const dayEl = e.target.closest(".day");
        if(!dayEl) return;
        const day = Number(dayEl.dataset.day);
        openModal(day);
      });

      // list modal buttons
      document.getElementById("openGood").onclick = ()=> openListModal("good");
      document.getElementById("openBad").onclick = ()=> openListModal("bad");
    }

    // ---------- Modal Logic ----------
    function ensureDrink(dateKey, idx){
      if(!state.records[dateKey]) state.records[dateKey] = [];
      const list = state.records[dateKey];

      while(list.length <= idx){
        list.push({ shop:"", item:"", ice:"去冰", sugar:"無糖", price:0, rating:null });
      }
      return list[idx];
    }

    function canShowSlot(list, idx){
      // ✅ 修你卡第二杯的問題：只要上一杯「存在」就顯示下一杯，不用 item 有字才算
      if(idx===0) return true;
      return !!list[idx-1];
    }

    function openModal(day){
      state.selectedDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day);
      lastActiveIdx = 0;
      modalScrollTop = 0;
      renderModal();
    }

    function renderModal(){
      const dateKey = formatDateKey(state.selectedDate);
      const list = state.records[dateKey] || [];

      // build 0..2
      let cards = "";
      for(let i=0;i<3;i++){
        if(!canShowSlot(list, i)) continue;

        const drink = list[i];
        const exists = !!drink;

        if(!exists){
          cards += `
            <div class="drinkCard add">
              <button class="addBtn" data-add="${i}">
                ${iconPlus()}
                <div>新增第 ${i+1} 杯</div>
              </button>
            </div>
          `;
          continue;
        }

        cards += `
          <div class="drinkCard" data-idx="${i}">
            <div class="drinkTop">
              <div class="noPill">NO.${i+1}</div>
              <div class="tools">
                <button class="toolBtn ${drink.rating==="good"?"on good":""}" data-rate="good" data-idx="${i}" title="讚讚">${iconThumbUp()}</button>
                <button class="toolBtn ${drink.rating==="bad"?"on bad":""}" data-rate="bad" data-idx="${i}" title="踩雷">${iconThumbDown()}</button>
                <button class="toolBtn trash" data-del="${i}" title="刪除">${iconTrash()}</button>
              </div>
            </div>

            <div class="field2">
              <input type="text" inputmode="text" autocomplete="off" placeholder="店家"
                data-field="shop" data-idx="${i}" value="${escapeAttr(drink.shop||"")}" />
              <input type="text" inputmode="text" autocomplete="off" placeholder="品項"
                data-field="item" data-idx="${i}" value="${escapeAttr(drink.item||"")}" />
            </div>

            <div class="label">甜度</div>
            <div class="optRow">
              ${sugarOptions.map(opt=>`
                <button class="opt ${drink.sugar===opt?"on":""}" data-field="sugar" data-idx="${i}" data-val="${escapeAttr(opt)}">${opt}</button>
              `).join("")}
            </div>

            <div class="label">冰量</div>
            <div class="optRow">
              ${iceOptions.map(opt=>`
                <button class="opt ${drink.ice===opt?"on":""}" data-field="ice" data-idx="${i}" data-val="${escapeAttr(opt)}">${opt}</button>
              `).join("")}
            </div>

            <div class="priceWrap">
              <div class="dollar">$</div>
              <input type="number" inputmode="decimal" class="priceInput" placeholder="金額"
                data-field="price" data-idx="${i}" value="${drink.price?Number(drink.price):""}" />
            </div>
          </div>
        `;
      }

      const overlay = document.createElement("div");
      overlay.className = "overlay";
      overlay.id = "modalOverlay";
      overlay.innerHTML = `
        <div class="sheet" id="sheet">
          <div class="sheetHead">
            <h3>${state.selectedDate.getMonth()+1}月${state.selectedDate.getDate()}日</h3>
            <button class="closeBtn" id="closeModal">✕</button>
          </div>

          <div id="cards">${cards}</div>

          <button class="saveBig" id="saveClose">儲存紀錄</button>
        </div>
      `;

      const old = document.getElementById("modalOverlay");
      if(old) old.remove();
      document.body.appendChild(overlay);

      const sheet = document.getElementById("sheet");
      sheet.scrollTop = modalScrollTop;

      // Bind close
      document.getElementById("closeModal").onclick = closeModal;
      document.getElementById("saveClose").onclick = closeModal;

      // track scroll
      sheet.addEventListener("scroll", ()=>{ modalScrollTop = sheet.scrollTop; }, {passive:true});

      // Event delegation inside modal
      overlay.addEventListener("click",(e)=>{
        const add = e.target.closest("[data-add]");
        if(add){
          const idx = Number(add.dataset.add);
          ensureDrink(dateKey, idx);
          saveData();
          lastActiveIdx = idx;
          // 只重繪 modal（不重繪整頁），避免焦點亂跳
          rerenderModalKeep();
          focusFirstField(idx, "shop");
          return;
        }

        const del = e.target.closest("[data-del]");
        if(del){
          const idx = Number(del.dataset.del);
          const list2 = state.records[dateKey] || [];
          list2.splice(idx, 1);
          if(list2.length===0) delete state.records[dateKey];
          saveData();
          lastActiveIdx = Math.max(0, idx-1);
          rerenderModalKeep();
          return;
        }

        const rate = e.target.closest("[data-rate]");
        if(rate){
          const idx = Number(rate.dataset.idx);
          const r = rate.dataset.rate;
          ensureDrink(dateKey, idx);
          const d = state.records[dateKey][idx];
          d.rating = (d.rating===r) ? null : r;
          saveData();
          lastActiveIdx = idx;
          rerenderModalKeep();
          return;
        }

        const opt = e.target.closest(".opt");
        if(opt){
          const idx = Number(opt.dataset.idx);
          const field = opt.dataset.field;
          const val = opt.dataset.val;
          ensureDrink(dateKey, idx);
          state.records[dateKey][idx][field] = val;
          saveData();
          lastActiveIdx = idx;
          rerenderModalKeep();
          // 不搶 focus
          return;
        }
      });

      // Inputs (Chinese IME safe)
      overlay.querySelectorAll('input[data-field]').forEach(inp=>{
        inp.addEventListener("compositionstart", ()=>{ isComposing = true; });
        inp.addEventListener("compositionend", (e)=>{
          isComposing = false;
          // 組字結束補一次存檔
          commitInput(e.target);
        });

        // oninput：組字期間不 commit（避免注音被打斷）
        inp.addEventListener("input",(e)=>{
          if(isComposing) return;
          commitInput(e.target);
        });

        // blur：保底存檔
        inp.addEventListener("blur",(e)=>{
          if(isComposing) return;
          commitInput(e.target);
        });

        // focus：記住最後編輯哪杯，避免你說新增後跳回第一杯
        inp.addEventListener("focus",(e)=>{
          const idx = Number(e.target.dataset.idx);
          lastActiveIdx = idx;
        });
      });

      // 自動把畫面捲到 lastActiveIdx 卡片（不會跳回 NO.1）
      scrollToCard(lastActiveIdx);
    }

    function commitInput(inputEl){
      const dateKey = formatDateKey(state.selectedDate);
      const idx = Number(inputEl.dataset.idx);
      const field = inputEl.dataset.field;
      ensureDrink(dateKey, idx);

      let v = inputEl.value;
      if(field==="price"){
        state.records[dateKey][idx][field] = (v===""?0:Number(v));
      }else{
        state.records[dateKey][idx][field] = v;
      }
      saveData();
      // ⭐ 這裡刻意不重繪 modal、不重繪主畫面，避免打字跳焦/卡中文
    }

    function rerenderModalKeep(){
      const sheet = document.getElementById("sheet");
      if(sheet) modalScrollTop = sheet.scrollTop;
      renderModal();
    }

    function scrollToCard(idx){
      const sheet = document.getElementById("sheet");
      if(!sheet) return;
      const card = sheet.querySelector(`.drinkCard[data-idx="${idx}"]`);
      if(card){
        card.scrollIntoView({block:"nearest"});
      }
    }

    function focusFirstField(idx, field){
      const overlay = document.getElementById("modalOverlay");
      if(!overlay) return;
      const el = overlay.querySelector(`input[data-idx="${idx}"][data-field="${field}"]`);
      if(el){
        setTimeout(()=>el.focus(), 0);
      }
    }

    function closeModal(){
      const m = document.getElementById("modalOverlay");
      if(m) m.remove();
      // 關閉後更新主畫面（統計/日曆金額）
      render();
    }

    // ---------- List Modal ----------
    function openListModal(type){
      const stats = calcStats();
      const list = (type==="good") ? stats.goodList : stats.badList;
      const title = (type==="good") ? "讚讚清單" : "踩雷紀錄";
      const colorClass = (type==="good") ? "goodColor" : "badColor";
      const icon = (type==="good") ? iconThumbUp() : iconThumbDown();

      const items = list.length ? list.map(d=>`
        <div class="listItem">
          <div>${escapeHtml(d.name)}</div>
          <div class="date">${escapeHtml(d.date.slice(5))}</div>
        </div>
      `).join("") : `<div class="empty">尚無資料</div>`;

      const overlay = document.createElement("div");
      overlay.className = "centerOverlay";
      overlay.id = "listOverlay";
      overlay.innerHTML = `
        <div class="centerCard">
          <div class="centerTitle ${colorClass}">
            ${icon}
            <div>${title}</div>
          </div>
          <div class="list">${items}</div>
          <button class="closeCenter" id="closeList">關閉</button>
        </div>
      `;
      overlay.addEventListener("click",(e)=>{
        if(e.target.id==="listOverlay") overlay.remove();
      });
      document.body.appendChild(overlay);
      document.getElementById("closeList").onclick = ()=>overlay.remove();
    }

    // ---------- Helpers ----------
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s); }

    // ---------- Start ----------
    render();
  </script>
</body>
</html>